/*! lightbox 04-08-2014 */
function Lightbox(a){this.defaults={development:!0,selectors:{workspace1:"#workspace1",workspace2:"#workspace2"},toolbar:{moveRight:200,moveLeft:200,zoomIn:.3,zoomOut:.3}},a&&$.extend(this.defaults,a),this.selectors={body:$("body"),html:$("html"),workspace1:$(this.defaults.selectors.workspace1),workspace2:$(this.defaults.selectors.workspace2)},this.align={_self:this,align:function(a){for(var b=$(".selected"),c=$(window).scrollTop(),d=0;d<b.length;d++)img=$(b[d]),img.css("position","relative").css("margin","10px"),img.index()?(img.css({position:"relative"}),"Top"==a?img.animate({top:0},100):"Bottom"==a?(c=$(window).height()-img.height(),img.animate({top:c},100)):"Center"==a?(c=($(window).height()-img.height())/2,img.animate({top:c},100)):"Left"==a?img.animate({left:$(window).scrollLeft()},100):"Right"==a&&img.animate({left:$(window).width()/2},100)):"Top"==a?img.animate({top:0},100):"Bottom"==a?(c=$(window).height()-img.height(),img.animate({top:c},100)):"Center"==a?(c=($(window).height()-img.height())/2,img.animate({top:c},100)):"Left"==a?img.animate({left:$(window).scrollLeft()},100):"Right"==a&&img.animate({left:$(window).width()/2},100)}},this.crop={_self:this,active:!1,init:function(a){this.buttons(a)},crop:function(a){var b,c=a.find("img");$(c).Jcrop({keySupport:!1,setSelect:!1,onSelect:function(){1!==$(_self.workspaceImages.workspace).css("zoom")&&$(_self.workspaceImages.workspace).css("zoom",1),a.css("transform","rotate(0deg)"),b=this,_self.crop.active=!0,_self.toolbar.selectors.buttons.crop_image.fadeIn()},onChange:this.show_coords,onRelease:function(){b=this,_self.crop.active=!1,b.destroy(),_self.toolbar.selectors.buttons.cropButton.removeClass("active"),_self.toolbar.selectors.buttons.crop_image.fadeOut()}})},show_coords:function(a){_self.crop.coords=[a.x,a.y,a.x2,a.y2]},buttons:function(){return _self.toolbar.selectors.buttons.cropButton.click(function(){return $(this).hasClass("active")?!1:($(this).addClass("active"),void _self.crop.crop($(".selected")))}),!1},destroy:function(){},get_image:function(){var a=_self.select_group.imagesSelected[0],b=a.find("img").width(),c=a.find("img").height(),d=function(){return a.data("is_letter")||a.data("external")?!0:!1},e={id:a.attr("id"),image:a.find("img").attr("src"),is_letter:d(),height:c,width:b,box:JSON.stringify(_self.crop.coords),manuscript:a.data("title"),is_external:a.data("external")};try{$.ajax({type:"POST",url:"read-image/",data:e,beforeSend:function(){if($("#letter_wait_box").length)$("#letters_buttons_loading_box").hide().fadeIn().html("<img src='/static/img/ajax-loader2.gif' />"),$("#letter_crop_status").hide().fadeIn().html("Cropping region ...");else{var a="<div class='modal' id='letter_wait_box'><span id='letter_crop_status'>Cropping region ...</span><div id='letters_buttons_loading_box'><img src='/static/img/ajax-loader2.gif' /></div>";_self.selectors.body.append(a),$("#letter_wait_box").fadeIn()}},success:function(a){return _self.letters.addLetter(a),!1},complete:function(){var a=$("#letter_wait_box");if(_self.letters.open)a.fadeOut().remove(),$("#importing_letter_ajax").fadeOut().remove();else{var b="<button id='open-letter-box' class='btn btn-primary'>Open Letters Window</button> <button class='btn btn-danger' id='close-letter-box'>Close</button>";$("#letters_buttons_loading_box").hide().fadeIn().html(b),$("#letter_crop_status").hide().fadeIn().html("Region cropped!"),$("#close-letter-box").click(function(){a.fadeOut().remove()}),$("#open-letter-box").click(function(){a.fadeOut().remove(),_self.letters.open_lettersbox()}),a.data("completed",!0)}},error:function(){var a="<button id='open-letter-box' class='btn btn-primary'>Open Regions Window</button>";a+=" <button class='btn btn-danger' id='close-letter-box'>Close</button>",$("#letters_buttons_loading_box").hide().fadeIn().html(a),$("#letter_crop_status").hide().fadeIn().html("Something went wrong :(. Try again.!")}})}catch(f){console.warn(f);var g="<button id='open-letter-box' class='btn btn-primary'>Open Regions Window</button>";g+=" <button class='btn btn-danger' id='close-letter-box'>Close</button>",$("#letters_buttons_loading_box").hide().fadeIn().html(g),$("#letter_crop_status").hide().fadeIn().html("Something went wrong :(. Try again.!")}}},this.export={_self:this,open:!1,init:function(){this.buttons()},show:function(){this.open=!0;var a=$("#save").position();$("#save").hide(),$("#export").css({top:$("#buttons").position().top+a.top,left:"2%"}).show().animate({top:"20%",left:"29%",width:"42%",height:"25%",opacity:1},{duration:350,complete:function(){$("#close_export").click(function(){_self.export.hide()})}}).draggable()},hide:function(){this.open=!1,$("#save").show();$("#save").position();$("#export").animate({top:$("#buttons").position().top+$("#save").position().top,left:"2%",width:"0%",height:"0%",opacity:0},{duration:250,complete:function(){$(this).hide()}})},buttons:function(){$("#save").click(function(){_self.export.show()}),$("#save_to_pc").click(function(){_self.export.main()})},exportImages:function(){var a=$(".image_active");return a},exportImagesProperties:function(a){for(var b=[],c=function(a){var b=a.offset();return b},d=function(a){var b=a.data("size");return b},e=function(a){return a.find("img").css("z-index")},f=function(a){var b=a.find("img").css(["width","height"]);return{width:b.width,height:b.height}},g=function(){String.prototype.getNums=function(){var a=/[+-]?((\.\d+)|(\d+(\.\d+)?)([eE][+-]?\d+)?)/g,b=this.match(a)||[];return b.map(Number)};var a,b=$("#slider_brightness").slider("option","value");return a="object"!=typeof b?b:200},h=0;h<a.length;h++){var i={opacity:$(a[h]).find("img").css("opacity"),brightness:g(),filter:$(a[h]).find("img").css("-webkit-filter"),transform:$(a[h]).find("img").css("transform"),is_letter:$(a[h]).data("is_letter"),classes:$(a[h]).find("img").attr("class")},j={image:$(a[h]).attr("id"),position:c($(a[h])),size:f($(a[h])),original_size:d($(a[h])),properties:i,workspace:$(a[h]).closest(".workspace").attr("id"),"z-index":e($(a[h]))};if($(a[h]).data("is_letter")){var k=$(a[h]).find("img").attr("src");j.src=k}else j.src=!1;b.push(j)}return b},export_stickable_notes:function(){var a=[],b={},c=$(".stickable_note");return c.each(function(){b.position=$(this).offset(),b.content=$(this).text(),b.id=$(this).attr("id"),b.workspace=$(this).closest(".workspace").attr("id"),b.data={image:$(this).data("image"),title:$(this).data("title"),id:$(this).data("id")},b.size={width:$(this).width(),height:$(this).height()},b.classes=$(this).attr("class"),a.push(b)}),a},export_letters:function(){var a=_self.letters.regions;if(a.length){for(var b=[],c=0;c<a.length;c++){for(var d={manuscript:a[c].title,id:a[c].id,letters:[]},e=0;e<a[c].letters.length;e++){var f={src:a[c].letters[e].attr("src"),size:a[c].letters[e].data("size"),id:a[c].letters[e].attr("id"),manuscript:a[c].letters[e].data("manuscript"),manuscript_id:a[c].letters[e].data("manuscript").manuscript_id,title:a[c].letters[e].data("manuscript").title};d.letters.push(f)}b.push(d)}return b}return!1},export_session_properties:function(){var a=function(){if(_self.toolbar.init(),_self.toolbar.exists())var a={position:_self.toolbar.toolbox.position()};else var a=!1;return a},b=this.export_letters(),c=function(){return{top:$(window).scrollTop(),left:$(window).scrollLeft()}},d=this.export_stickable_notes(),e={toolbar:a(),comments:_self.comments.notes,letters:b,stickable_notes:d,window:c()};return e},create:function(){var a=this.exportImages(),b=this.exportImagesProperties(a),c=this.export_session_properties(),d={session_file:!0,session_properties:c,image_properties:b};return d},main:function(){var a=_self.export.create(),b=$("#name_export").val();if(""!=b)if(null===localStorage.getItem(b)){localStorage.setItem(b,JSON.stringify(a));var c=localStorage.getItem(b);_self.import.files.push([b,c]),_self.import.manager&&_self.import.refreshView(),$("#export").fadeOut(),$("#save").fadeIn(),$.fn.notify({type:"success",text:"Session successfully saved","close-button":!0,position:{top:"8%",left:"79%"}})}else $.fn.notify({type:"error",text:"The name chosen already exists. Please try again","close-button":!0,position:{top:"8%",left:"79%"}});else $.fn.notify({type:"error",text:"Insert a valid name to save this session","close-button":!0,position:{top:"8%",left:"79%"}})}},this.loadExternalImages={_self:this,init:function(a){var b=this.parse(a);if(b.length){var c=JSON.parse(b[0]),d=[];for(i=0;i<c.length;i++)d.push(c[i]);var e;e="images"==a?{images:JSON.stringify(d)}:{annotations:JSON.stringify(d)};var f=$.get("images/",e);f.done(function(a){_self.import.printImages(a)&&(_self.imagesBox.to_workspace(),$("#hidden_div").remove())})}},parse:function(a){var b=_self.utils.getParameter(a);return b}},this.imagesBox={_self:this,open:!0,imagesSelected:[],imagesBox:$("#barLeft"),init:function(){this.buttons()},show:function(){this.open=!0,$("#button_images").tooltip("hide").fadeOut().remove(),this.imagesBox.show().draggable({handle:".top_box"}).animate({top:"5%",left:"20%",width:"60%",height:"90%",opacity:1},250)},hide:function(){this.open=!1;var a=" <div data-toggle='tooltip' data-placement='right' data-container='body' title='Browse Manuscripts' id='button_images' class='glyphicon glyphicon-search'></div>",b=$("#button_toolbar"),c=$("#buttons");b.length?b.after(a):c.prepend(a);var d=$("#button_images");this.imagesBox.show().animate({top:c.position().top+d.position().top+30,left:"2%",width:0,height:0,opacity:0},{duration:250,complete:function(){$(this).hide(),d.tooltip({placement:"right",trigger:"hover"}).click(function(){_self.imagesBox.show()})}})},buttons:function(){$("#close_barLeft").click(function(){_self.imagesBox.hide($(this))}),$("#add_to_workspace").click(function(){_self.imagesBox.to_workspace()}),$(".image").click(function(){_self.imagesBox.select_image($(this))})},is_selected:function(a){return a.data("selected")?!0:!1},select_image:function(a){var b=_self.imagesBox.imagesSelected;if(_self.imagesBox.is_selected(a)){if(a.data("selected",!1),a.find("img").removeClass("selected_image"),b.length)for(var c=0;c<b.length;c++)if(a.attr("id")==$(b[c]).attr("id")){b.splice(c,1);break}}else"undefined"!=typeof a&&(_self.imagesBox.imagesSelected.push(a),a.data("selected",!0),a.find("img").addClass("selected_image"))},to_workspace:function(a){{var b=_self.imagesBox.imagesSelected;$(".image")}if(b.length){for(var c=($("#overview").offset(),0);c<b.length;c++){var d=$(b[c]).unbind().removeClass("image selected_image").addClass("image_active");if(d.data("external")){var e=d.data("size").split(",");d.css({width:e[0]/2}),d.children(".ui-wrapper").css({width:e[0]/2}),d.children(".ui-wrapper").children("img").css({width:e[0]/2})}else d.find("img").after("<label>"+d.data("title")+"</label>");{var f=_self.workspaceImages.workspace;d.attr("id")}d.data("workspace",f),d.data("original_id",g);var g=d.attr("id");$(f).append(d);var h;h=d.index()?d.prev().width()+150:$(window).scrollLeft()+150;var i=$(window).scrollTop()+50,j=h;$(b[c]).css({top:i,left:j,position:"relative"}),$(b[c]).dblclick(function(a){_self.select_group.select($(this)),a.stopPropagation()});{d.find("img").attr("src")}}"undefined"==typeof a&&_self.workspaceImages.init(),_self.imagesBox.imagesSelected=[],$("html, body").animate({scrollTop:d.position().top-100,scrollLeft:d.position().left-450+"px"},500)}else $.fn.notify({type:"error","close-button":!0,position:{top:"8%",left:"80%"},text:"You should insert at least one image."})}},this.import={_self:this,open:!1,manager:!1,files:[],init:function(){this.buttons(),this.refresh()},show:function(){this.open=!0;var a=$("#import");if(this.manager)a.show().animate({top:"5%",left:"20%",width:"60%",height:"90%",opacity:1},{duration:250}).draggable({handle:".top_box"});else{var b=$("#load").position();a.css({top:$("#buttons").position().top+b.top,left:"2%"}),$("#load").hide(),a.show().animate({top:"14%",left:"28%",width:"40%",height:"25%",opacity:1,"z-index":400},{duration:250,complete:function(){$("#close_import").click(function(){_self.import.hide()}),$("#open_load_from_pc").click(function(){_self.import.show_manager()})}}).draggable({handle:".top_box"})}},hide:function(){this.open=!1,$("#load").show();var a=$("#load").position();$("#import").animate({top:$("#buttons").position().top+a.top,left:"2%",width:"0%",height:"0%",opacity:0},{duration:250,complete:function(){$(this).hide()}})},buttons:function(){$("#load").click(function(){_self.import.show()})},refresh:function(){for(var a,b=0,c=localStorage.length;c>b;b++){var d=localStorage.key(b),e=localStorage[d];try{a=JSON.parse(e)}catch(f){continue}a&&a.session_file&&this.files.push([d,e])}},refreshView:function(){for(var a="",b=0;b<this.files.length;b++)a+="<div class='folder' id='"+this.files[b][0]+"'><img src='/static/img/folder.png' /><div class='folder_title'>"+this.files[b][0]+"</div></div>",b&&b%7===0&&(a+='<br clear="all">');$("#import").children(".box_container").html(a),$(".folder").click(function(){_self.import.selectItem($(this))}),$(".folder").dblclick(function(){_self.import.loadFile($selectedItem.attr("id")),$selectedItem.children("img").css("opacity",1),$selectedItem=void 0})},selectItem:function(a){"undefined"!=typeof $selectedItem&&$selectedItem.children("img").css("opacity","1"),$selectedItem=a,$selectedItem.children("img").css("opacity","0.5")},show_manager:function(){$("#import").show().animate({top:"5%",left:"20%",width:"60%",height:"90%",opacity:1,"z-index":400},{duration:250,complete:function(){for(var a="",b=_self.import.files,c=0;c<b.length;c++)a+="<div class='folder col-lg-3' id='"+b[c][0]+"'><img src='/static/img/folder.png' /><div class='folder_title'>"+b[c][0]+"</div></div>",c&&c%7===0&&(a+='<br clear="all">');var d="<div class='row-fluid'><div style='line-height:2;margin:0;'";d+="class='breadcrumb'><li><a id='back_to_load'>Load a session</a> </li>",d+="<li class='active'>Local Manager</li>",d+=" <li class='pull-right no-before'><button id='load_session_button' class='btn btn-primary btn-sm'>Load</button> ",d+="<button id='delete_session_button' class='btn btn-danger btn-sm'>Delete</button></li></div></div>",$("#top_load_box").html(d).slideDown(100),$(this).children(".box_container").css("margin",0).html(a),$(".folder").click(function(){_self.import.selectItem($(this))}),$(".folder").dblclick(function(){_self.import.loadFile($selectedItem.attr("id")),$selectedItem.children("img").css("opacity",1),$selectedItem=void 0}),$("#load_session_button").click(function(){return"undefined"==typeof $selectedItem?!1:(_self.import.loadFile($selectedItem.attr("id")),$selectedItem.children("img").css("opacity",1),$selectedItem=void 0,void 0)}),$("#delete_session_button").click(function(){return"undefined"==typeof $selectedItem?!1:(_self.import.delete_session($selectedItem.attr("id")),$selectedItem.children("img").css("opacity",1),$selectedItem.fadeOut(300).remove(),$selectedItem=void 0,void 0)}),_self.import.manager=!0,$("#back_to_load").click(function(){var a=$("#import"),b="<button id='open_load_from_pc' class='btn btn-primary'>Load from File</button> ";b+="<button id='load_from_db' class='btn btn-primary disabled'>Load from your Account</button>",a.children(".box_container").html(b),$("#top_load_box").slideUp(100),a.show().animate({top:"14%",left:"29%",width:"40%",height:"25%",margin:0,opacity:1,"z-index":400},{duration:250,complete:function(){_self.import.manager=!1,$("#open_load_from_pc").click(function(){_self.import.show_manager()})}})}).draggable()}})},delete_session:function(a){a in localStorage&&localStorage.removeItem(a);for(var b=0;b<this.files.length;b++)if(this.files[b][0]==a){this.files.splice(b,1);break}},loadFile:function(a){var b=localStorage.getItem(a);_self.import.parse(b),$("#import").fadeOut(),$("#load").fadeIn()},parse:function(a){for(var b=JSON.parse(a),c=[],d=[],e=[],f=b.session_properties.toolbar,g=0;g<b.image_properties.length;g++)c.push(b.image_properties[g].image);for(g=0;g<b.session_properties.comments.length;g++)d.push(b.session_properties.comments[g]);for(g=0;g<b.session_properties.letters.length;g++)e.push(b.session_properties.letters[g]);this.reset(),_self.import.reloadImages(c,b.image_properties),_self.import.importComments(d),_self.import.importLetters(e),_self.import.importStickableNotes(b.session_properties.stickable_notes),f&&_self.import.restoreToolbar(f),$("html, body").animate({scrollTop:b.session_properties.window.top,scrollLeft:b.session_properties.window.left},1e3)},reloadImages:function(a,b){for(var c=[],d=[],e=0;e<a.length;e++)b[e].properties.is_letter?d.push(b[e]):$.ajax({type:"POST",url:"get-image-manuscript/",data:{image:a[e]},async:!1,beforeSend:function(){},success:function(a){c.push(a)},complete:function(){}});_self.import.printImages(c,b),_self.import.printLetters(d)},printLetters:function(a){for(var b=0;b<a.length;b++){var c=unescape(a[b].src),d="<div data-size = '"+a[b].original_size+"' class='image_active' id='"+a[b].image+"'><img src='"+unescape(c)+"' /></div>";$("#"+a[b].workspace).append(d),$("#"+a[b].image).css({position:"absolute",top:a[b].position.top,left:a[b].position.left,"max-width":"none","-webkit-filter":a[b].properties.filter,"-moz-filter":a[b].properties.filter,filter:a[b].properties.filter,"-ms-filter":a[b].properties.filter,"-o-filter":a[b].properties.filter,filter:a[b].properties.filter,"-webkit-transform":a[b].properties.transform,"-moz-transform":a[b].properties.transform,"-ms-transform":a[b].properties.transform,"-o-transform":a[b].properties.transform,transform:a[b].properties.transform,"max-width":"none","z-index":a[b].properties["z-index"]}).draggable({revert:!1,scroll:!0,opacity:.8,stack:".image_active",cursor:"move",aspectRatio:!0,drag:function(){position=$(this).offset()},stop:function(a){$(a.helper).css("z-index",0)}}).data("is_letter",!0).children("img").css({width:a[b].size.width,height:a[b].size.height}).resizable({aspectRatio:!0,resize:function(a){return _self.toolbar.refreshSize(),a.stopPropagation(),!1}}).children("img").css({opacity:a[b].properties.opacity}).addClass(a[b].properties.classes),$("#"+a[b].image).dblclick(function(a){_self.select_group.select($(this)),a.stopPropagation()})}},printImages:function(a,b){for(var c=0;c<a.length;c++)if(b){var d='<div data-external="true" data-size = "'+b[c].original_size+'" data-title = "'+a[c][2]+'" class="image_active" id = "'+parseInt(a[c][1])+'">'+a[c][0]+"<label>"+a[c][2]+"</label> <div class='image_desc col-lg-8 col-md-8 col-xs-8 offset1 image_desc'> <p><b>Manuscript</b>: "+a[c][2]+"</p> <p><b>Repository</b>: "+a[c][3]+"<p><b>Place</b>: "+a[c][4]+"</p></div><br clear='all' /></div>";if($("#"+b[c].workspace).append(d),b[c].image==a[c][1]){{$("#"+a[c][1]).find("img")}$("#"+a[c][1]).css({position:"absolute",top:b[c].position.top,left:b[c].position.left,"max-width":"none","max-height":"none","z-index":b[c].properties["z-index"]}).draggable({revert:"valid",scroll:!0,opacity:.7,stack:".image_active",cursor:"move",drag:function(){position=$(this).offset()}}).children("img").css({opacity:b[c].properties.opacity,"-webkit-filter":b[c].properties.filter,"-moz-filter":b[c].properties.filter,filter:b[c].properties.filter,"-ms-filter":b[c].properties.filter,"-o-filter":b[c].properties.filter,filter:b[c].properties.filter,"-webkit-transform":b[c].properties.transform,"-moz-transform":b[c].properties.transform,"-ms-transform":b[c].properties.transform,"-o-transform":b[c].properties.transform,transform:b[c].properties.transform,"max-width":"none",width:b[c].size.width,height:b[c].size.height}).resizable({aspectRatio:!0,resize:function(a){return _self.toolbar.refreshSize(),a.stopPropagation(),!1}}).addClass(b[c].properties.classes).removeClass("col-md-4 col-xs-4 col-lg-4"),$("#"+a[c][1]).dblclick(function(a){_self.select_group.select($(this)),a.stopPropagation()})}}else{var d='<div data-external="true" data-size = "'+a[c][4]+'" data-title = "'+a[c][2]+'" class="image" id = "'+parseInt(a[c][1])+'">'+a[c][0]+" <label>"+a[c][2]+"</label><div class='col-lg-8 col-md-8 col-xs-8 offset1 image_desc'> <p><b>Manuscript</b>: "+a[c][2]+"</p> <p><b>Repository</b>: "+a[c][3]+"<p><b>Place</b>: "+a[c][4]+"</p></div><br clear='all' /></div>";$("#hidden_div").append(d),_self.imagesBox.imagesSelected.push($(d))}return _self.imagesBox.imagesSelected.length?!0:void 0},importComments:function(a){_self.comments.notes=a;for(var b=0;b<a.length;b++)_self.comments.update_notes(a[b])},importStickableNotes:function(a){for(var b=0;b<a.length;b++){{$("#"+a[b].workspace)}_self.comments.create_stickable_note(a[b].id,a[b].data.image,a[b].data.title,a[b].content);var c=$("#"+a[b].id);c.css({position:"absolute",top:a[b].position.top,left:a[b].position.left,width:a[b].size.width,height:a[b].size.height}).addClass(a[b].classes),$("#"+a[b].workspace).append(c)}},importLetters:function(a){for(var b=0;b<a.length;b++)for(var c=0;c<a[b].letters.length;c++){var d=$("<img>");d.attr("class","letter"),d.attr("id",a[b].letters[c].id),d.attr("src",a[b].letters[c].src),d.data("size",a[b].letters[c].size),d.data("manuscript",a[b].letters[c].manuscript),d.data("manuscript_id",a[b].letters[c].manuscript_id),d.data("title",a[b].letters[c].title),_self.letters.addLetter(d)}},restoreToolbar:function(){_self.toolbar.init(),_self.toolbar.create(null,!0),_self.toolbar.refresh()},reset:function(){_self.comments.notes=[],_self.workspaceImages.imagesSelected=[],_self.letters.lettersSelected=[],$(".image_active").remove(),$(".image").remove(),$(".letter").remove(),$(".stickable_note").remove(),_self.minimap.clean_minimap(),_self.comments.clean_notes(),_self.select_group.imagesSelected=[],_self.toolbar.exists()&&_self.toolbar.toolbox.remove()}},this.is_selected=function(){return"undefined"!=typeof $selectedImage&&$(this).attr("id")==$selectedImage.attr("id")?!0:!1},this.images_on_workspace=function(){var a=$(".image_active");return a},this.init=function(){function a(a,b,c){"in"==a?j+=c:j-=c;var d=$(_self.workspaceImages.workspace);if(void 0!==document.body.style.webkitFilter)d.animate({zoom:j},400,function(){_self.selectors.html.add(_self.selectors.body).animate({left:j*_self.selectors.body.position().left,top:j*_self.selectors.body.position().top},0)});else{d.css({"-moz-transform":"scale("+j+")","-moz-transform-origin":"50% 100%","-o-transform":"scale("+j+")","-o-transform-origin":"50% 100%","-ms-transform":"scale("+j+")","-ms-transform-origin":"50% 100%"});var e=_self.selectors.body.position().left,f=_self.selectors.body.position().top;_self.selectors.html.add(_self.selectors.body).animate({left:e-100*j,top:f-100*zoom_vaue},0)}i.fadeIn().html(Math.floor(100*j)+"% <span class='caret'></span>")}function b(a,b){var c,d=$(window).scrollLeft();c="dx"==a?d+b:d-b,_self.selectors.html.animate({scrollLeft:c},350),_self.selectors.body.animate({scrollLeft:c},350)}function c(){$("#container").css("background","background-color: #444"),k.css({background:"#444",display:"none",overflow:"visible"}),$(_self.workspaceImages.workspace).css("display","block"),k.animate({zoom:j,background:"#444"},150).css({margin:"0","-moz-transform":"none","-ms-transform":"none","-o-transform":"none"}).removeClass("toggle"),$("#container").css({background:"#444",padding:0}),$("#overview").show(),$("html, body").css("background","#444"),n=0,i.fadeIn().html(Math.floor(100*j)+"% <span class='caret'></span>");var a=$(".image_active");$.each(a,function(){var a=$(this).attr("id");$("#"+_self.minimap.namespace+a).css(_self.workspaceImages.workspace!=$(this).data("workspace")?{display:"none"}:{display:"block"})}),m||($("#workspace1").removeClass("workspace-absolute-1"),$("#workspace2").removeClass("workspace-absolute-2"),$("#workspace3").removeClass("workspace-absolute-3"),$("#workspace4").removeClass("workspace-absolute-4")),l.removeClass("active"),$('[data-id="'+_self.workspaceImages.workspace+'"]').addClass("active"),$("#zoom_in").add("#zoom_out").data("disabled",!1).removeClass("disabled"),_self.menu.show()}function d(a){return $(document).on("contextmenu",function(){return!1}),2==a.button?!1:void 0}_self=this,_self.menu.init(),_self.imagesBox.init(),_self.export.init(),_self.import.init(),_self.keyboardEvents.init(),Array.prototype.clean=function(a){for(var b=0;b<this.length;b++)this[b]==a&&(this.splice(b,1),b--);return this};$('#buttons *[data-toggle="tooltip"]').tooltip({placement:"right",trigger:"hover"}),$('#topbar *[data-toggle="tooltip"]').tooltip({placement:"bottom",container:"body",trigger:"hover"}),$("#marker").draggable({scroll:!1,opacity:.5,cursor:"move",containment:$("#overview"),appendTo:"body",revert:"invalid"}),$(window).scroll(function(){var a={top:$(window).scrollTop()/$(document).height()*180,left:$(window).scrollLeft()/$(document).width()*250};$("#marker").animate({left:a.left,top:a.top},0)}),$("#notes_button").click(function(){_self.comments.show_notes(),_self.comments.openFolder&&_self.comments.back_to_notes()}),$("#letters_button").click(function(){_self.letters.open_lettersbox()});var e=$("#zoom_in"),f=$("#zoom_out"),g=$("#move_left"),h=$("#move_right"),i=$("#counter_zoom"),j=1,k=$(".workspace"),l=$(".workspace-switcher"),m="WebkitAppearance"in document.documentElement.style;$(_self.workspaceImages.workspace).fadeIn(50),e.click(function(b){$(this).data("disabled")||a("in",b,_self.defaults.toolbar.zoomIn)}),f.click(function(b){$(this).data("disabled")||a("out",b,_self.defaults.toolbar.zoomOut)}),g.click(function(){b("sx",_self.defaults.toolbar.moveLeft)}),h.click(function(){b("dx",_self.defaults.toolbar.moveRight)}),e.add(f).add(g).add(h).dblclick(function(a){a.stopPropagation()});var n=0,o=$("#workspace");uniqueid=function(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;5>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a},o.on("click",function(){if(n)c();else{var a=$("#set_size"),b=2*(100/k.length-3);k.css({display:"block","background-color":"#666",margin:"0.1%","margin-top":"0",overflow:"hidden","-moz-transform":"scale("+b/100+")","-moz-transform-origin":"0 0","-o-transform":"scale("+b/100+")","-o-transform-origin":"0 0","-ms-transform":"scale("+b/100+")","-ms-transform-origin":"0 0"}).animate({zoom:b+"%",width:$(window).width(),height:$(window).height()},100).addClass("toggle"),n=1,m||($("#workspace1").addClass("workspace-absolute-1"),$("#workspace2").addClass("workspace-absolute-2"),$("#workspace3").addClass("workspace-absolute-3"),$("#workspace4").addClass("workspace-absolute-4")),a.attr("disabled",!0).addClass("disabled"),_self.selectors.body.css("width","auto"),_self.selectors.html.css("width","auto"),$("#container").css({background:"rgba(0, 0, 0, 0.6)","padding-left":"8%","padding-top":"4%"}),$("#overview").hide(),$("html, body").css("background","#000"),_self.menu.hide(),$(".toggle").unbind("click").on("click",function(){if(_self.workspaceImages.workspace!=="#"+$(this).attr("id")){var b=$(_self.workspaceImages.workspace).find(".image_active.selected");b.each(function(){_self.select_group.deselect($(this))}),_self.toolbar.refresh()}_self.workspaceImages.workspace="#"+$(this).attr("id"),c(),a.attr("disabled",!1).removeClass("disabled")}),$("#zoom_in").add("#zoom_out").data("disabled",!0).addClass("disabled")}}),_self.defaults.development||(document.onmousedown=d),(_self.utils.getParameter("images").length||_self.utils.getParameter("annotations").length)&&(_self.loadExternalImages.init("images"),_self.loadExternalImages.init("annotations"),_self.imagesBox.hide());var p=$(document).width(),q=$(document).height();k.css({width:2*$(window).width(),height:2*$(window).height()}),$(document).on("resize",function(){$(_self.workspaceImages.workspace).css({width:$(this).width(),height:$(this).height()})});var r=$("#overview");r.css({height:q/7.5,width:p/190});var s=!1;r.click(function(a){if(a.stopPropagation(),!s){s=!0;var b=_self.selectors.body,c=a.offsetX||a.clientX-$(a.target).position().left,d=a.offsetY||a.clientY-$(a.target).position().top,e=d/$(this).height()*100,f=c/$(this).width()*100,g=b.width()/100*f-100,h=b.height()/100*e-100;_self.selectors.body.animate({scrollLeft:g,scrollTop:h},800),_self.selectors.html.animate({scrollLeft:g,scrollTop:h},800);var i=$("<div>");i.addClass("pointer"),i.css({position:"absolute",left:c,top:d}),$(this).append(i),setTimeout(function(){i.remove()},1e3),s=!1}}),l.on("click",function(){var a=$(this).data("id");l.removeClass("active"),$(this).addClass("active");var b=$(_self.workspaceImages.workspace).find(".image_active.selected");b.each(function(){_self.select_group.deselect($(this))}),_self.toolbar.refresh(),a!==_self.workspaceImages.workspace&&(k.css("display","none"),$(a).fadeIn(100),_self.selectors.body.animate({scrollLeft:$(_self.workspaceImages.workspace).position().left,scrollTop:$(_self.workspaceImages.workspace).position().top},200,function(){_self.workspaceImages.workspace=a}),k.selectable({selected:function(a,b){$(b.selected).hasClass("image_active")&&!$(b.selected).hasClass("selected")&&_self.select_group.select_image($(b.selected))}}))}),l.droppable({accept:".selected",activeClass:"ui-state-hover",hoverClass:"ui-state-active",drop:function(){for(var a=0;a<_self.select_group.imagesSelected.length;a++)$($(this).data("id")).append(_self.select_group.imagesSelected[a]);_self.toolbar.deselectAll(),$(this).removeClass("switcher-drop");var b=$(_self.workspaceImages.workspace);b.find(".image_active").length||$(this).trigger("click")},over:function(){$(this).data("original-title","Move images to Workspace"+$(this).data("index")),$(this).addClass("switcher-drop")},out:function(){$(this).data("original-title","Go to Workspace "+$(this).data("index")),$(this).removeClass("switcher-drop")}}),k.on("dblclick",function(a){_self.crop.active||_self.toolbar.deselectAll(),$(".stickable_note").removeClass("selected"),a.stopPropagation()}),$("#load_image").unbind().on("change",function(a){_self.letters.import_image(a)}),$(".zoom-button").on("click",function(){var a=$(this).data("zoom");void 0!==document.body.style.webkitFilter?$(_self.workspaceImages.workspace).animate({zoom:a/100},200):$(_self.workspaceImages.workspace).css({"-moz-transform":"scale("+a/100+")","-moz-transform-origin":"50% 100%","-o-transform":"scale("+a/100+")","-o-transform-origin":"50% 100%","-ms-transform":"scale("+a/100+")","-ms-transform-origin":"50% 100%"}),j=a/100,$("#counter_zoom").html(a+"% <span class='caret'></span>")});var t=_self.utils.getCookie("csrftoken");$.ajaxSetup({headers:{"X-CSRFToken":t}}),$("#search").typeahead({source:array_pages}),$("[data-toggle='tooltip']").tooltip(),$("#back_to_digipal").on("click",function(){var a=_self.utils.getParameter("from");a.length||(a="/"),location.href=a}),k.selectable({selected:function(a,b){$(b.selected).hasClass("image_active")&&!$(b.selected).hasClass("selected")&&_self.select_group.select($(b.selected)),$(b.selected).hasClass("stickable_note")&&!$(b.selected).hasClass("selected")&&$(b.selected).addClass("selected")},delay:50}),_self.toolbar.init()},this.keyboardEvents={_self:this,init:function(){this.events()},events:function(){$(document).on("keydown",function(a){var b=a.keyCode?a.keyCode:a.which;a.altKey&&(78==b&&(_self.comments.open?_self.comments.hide_notes():_self.comments.show_notes()),73==b&&(_self.imagesBox.open?_self.imagesBox.hide():_self.imagesBox.show()),82==b&&(_self.letters.open?_self.letters.hide_letters():_self.letters.open_lettersbox()),83==b&&(_self.export.open?_self.export.hide():_self.export.show()),76==b&&(_self.import.open?_self.import.hide():_self.import.show()),77==b&&(_self.menu.open?_self.menu.hide():_self.menu.show()))})}},this.letters={open:!1,folderOpen:!1,lettersSelected:[],regions:[],letters:$(".letter"),letters_div:$("#letters"),init:function(a){this.buttons(a)},open_lettersbox:function(){var a=$("#letters_button").position();this.letters_div.css({top:$("#buttons").position().top+a.top+30,left:"2%"}),$("#letters_button").hide(),this.letters_div.show().animate({top:"5%",left:"20%",width:"60%",height:"90%",opacity:1,"z-index":400},{duration:250,complete:function(){$("#close_letters").unbind().click(function(){_self.letters.hide_letters()
}),$("#compare_letters").unbind().click(function(){var a=_self.letters.compare();_self.letters.show_comparison(a)}),$("#delete_letter").unbind().click(function(){_self.letters.delete()}),$("#load_xml").unbind().on("change",function(a){_self.letters.import_xml(a)}),$("#export_xml").unbind().click(function(){_self.letters.export_as_xml("xml")}),$("#export_html").unbind().click(function(){_self.letters.export_as_xml("html")}),$("#add_letters").unbind().click(function(){_self.letters.to_workspace()})}}).draggable({handle:".top_box"}),this.check_regions_length(),this.open=!0},hide_letters:function(){$("#letters_button").show();var a=$("#letters_button").position();this.letters_div.animate({top:a.top,left:"2%",width:"0%",height:"0%",opacity:0},{duration:250,complete:function(){$(this).hide()}}),this.open=!1},updateLetters:function(a){if(this.regions.length){var b=$(a).data("manuscript_id");$(a).data("manuscript_id")||(b=$(a).data("manuscript").id||$(a).data("manuscript").manuscript_id);var c=!1,d=$(".letter");d.unbind("click");for(var e=$("#letters_container"),f=0;f<this.regions.length;f++)if(this.regions[f].id==b){if($(a).hasClass("letter")&&this.regions[f].letters.push($(a)),this.folderOpen.status&&this.folderOpen.manuscript==this.regions[f].id)for(var g=0;g<this.regions[f].letters.length;){var h=this.regions[f].letters[g];e.append(h),g++}c=!0}return c?(d.click(function(){_self.letters.selectLetter($(this))}),$("#export_xml").removeClass("disabled"),$("#export_html").removeClass("disabled"),!0):!1}return $("#export_xml").removeClass("disabled"),$("#export_html").removeClass("disabled"),!1},check_regions_length:function(){_self.letters.regions.length?($("#export_xml").removeClass("disabled"),$("#export_html").removeClass("disabled")):($("#export_xml").addClass("disabled"),$("#export_html").addClass("disabled"))},updateFolders:function(a){var b=$(a).data("manuscript"),c=$(a).data("manuscript_id"),d=$("<div>");d.attr("class","manuscript_pack").addClass("col-lg-3"),d.attr("id","manuscript_"+c),d.data("title",b),d.append("<img src='/static/img/folder_pictures.png' />"),d.append("<div class='folder_title'>"+b+"</div>");var e={title:b,id:c,letters:[]};return this.regions.push(e),d.data("manuscript",e),this.check_regions_length(),d},addLetter:function(a){for(var b=$(a).data("manuscript_id"),c=!1,d=0;d<this.regions.length;d++)this.regions[d].id==b&&(c=!0);if(this.updateLetters(a)&&c)return!1;var e=this.updateFolders(a);if(!this.folderOpen.status){var f=$("#letters_container");f.append(e)}this.init($(e)),this.updateLetters(a)},update_regions_folders:function(a){var b,c,d,e,f,g=_self.letters.regions,h=$("#letters_container");a&&h.html("");for(var i=0;i<g.length;i++){e=g[i].title,d=g[i].id,c=$("<div>"),c.attr("class","manuscript_pack").addClass("col-lg-3"),c.attr("id","manuscript_"+d),c.append("<img src='/static/img/folder_pictures.png' />"),c.append("<div class='folder_title'>"+e+"</div>"),f={title:e,id:d,letters:[]};for(var j=0;j<g[i].letters.length;j++)b=g[i].letters[j],f.letters.push(g[i].letters[j]);c.data("manuscript",f),$("#manuscript_"+d).length||h.append(c)}a&&$(".manuscript_pack").unbind().click(function(){_self.letters.openFolder($(this)),$(this).fadeOut()})},make_workable:function(a){var b=$("<div id='image_"+a.attr("id")+"' class='image_active'><img src='"+a.attr("src")+"' /></div>");b.data("is_letter",!0),$(_self.workspaceImages.workspace).append(b),"undefined"==typeof a.data("title")?b.data("title","Region"):b.data("title",a.data("title")),a.data("size")&&b.data("size",a.data("size").split(",")[0]/2+","+a.data("size").split(",")[1]/2);var c=$("#overview").offset();b.children().resizable({aspectRatio:!0,resize:function(a){return _self.toolbar.refreshSize(),a.stopPropagation(),!1}});var d=$(window).scrollLeft();$("#image_"+a.attr("id")).prev().length&&(d=$("#image_"+a.attr("id")).prev().position().left),$("#image_"+a.attr("id")).css({top:c.top,left:d}).draggable({revert:!1,scroll:!0,opacity:.8,stack:".image_active",cursor:"move",aspectRatio:!0,drag:function(){position=$(this).offset()},stop:function(a){$(a.helper).css("z-index",0)}}),$("#image_"+a.attr("id")).dblclick(function(a){_self.select_group.select($(this)),a.stopPropagation()}),a.remove()},is_selected:function(a){return a.data("selected")?!0:!1},selectLetter:function(a){var b=this.lettersSelected;if(this.is_selected(a)){if(a.data("selected",!1),a.css("box-shadow","0px 0px 6px #666"),a.length)for(var c=0;c<b.length;c++)if(a.attr("id")==$(b[c]).attr("id")){this.lettersSelected.splice(c,1),c--;break}}else"undefined"!=typeof a&&(this.lettersSelected.push(a),a.data("selected",!0),a.css("boxShadow","0px 0px 8px 6px rgba(255, 246, 9, 0.94)"));var d=$("#selected_letters_number");d.html(this.lettersSelected.length+" selected")},buttons:function(a){a.click(function(){_self.letters.openFolder(a)})},openFolder:function(a){this.folderOpen={status:!0,manuscript:a.data("manuscript").id};var b=$("<div>");b.attr({"class":"breadcrumb",display:"none",id:"breadcrumb_letters"}),$(".manuscript_pack").fadeOut(),$("#letters_container").append(b.fadeIn(300));var c="<li><a class='link' id='to_regions'>Regions</a></li>";c+="<li class='active'>"+a.data("manuscript").title+"</li>",c+="<li class='pull-right no-before'><span id='to_regions_icon' class='glyphicon glyphicon-arrow-left' style='cursor:pointer;'></span></li>",$("#breadcrumb_letters").html(c);this.updateLetters(a);var d=_self.letters.lettersSelected;if(d.length)for(var e=0;e<d.length;e++)for(var f=0;f<a.data("manuscript").letters.length;f++){var g=a.data("manuscript").letters[f];if(d[e].attr("id")==g.attr("id"))g.data("selected",!0);else if(e>d.length)break}for(e=0;e<a.data("manuscript").letters.length;){var g=a.data("manuscript").letters[e];$("#letters_container").append(g.hide().fadeIn(300)),g.click(function(){_self.letters.selectLetter($(this))}),e++}$("#to_regions").click(function(){_self.letters.to_regions()}),$("#to_regions_icon").click(function(){_self.letters.to_regions()})},to_regions:function(){$(".letter").remove(),$(".manuscript_pack").fadeIn(150),$("#breadcrumb_letters").slideUp().remove(),_self.letters.folderOpen.status=!1,this.check_regions_length(),this.update_regions_folders(!0)},compare:function(){if(2==this.lettersSelected.length){var a=$("<img>"),b=$("<img>");a.attr({src:this.lettersSelected[0].attr("src"),id:this.lettersSelected[0].attr("id")}).css({display:"none"}),b.attr({src:this.lettersSelected[1].attr("src"),id:this.lettersSelected[1].attr("id")}).css({display:"none"}),_self.selectors.body.append(a),_self.selectors.body.append(b);var c=document.getElementById(a.attr("id")),d=document.getElementById(b.attr("id"));return resemble(c).compareTo(d).onComplete(function(a){result=a}).ignoreAntialiasing(),a.remove(),b.remove(),result}$.fn.notify({type:"error","close-button":!0,text:"Choice two images to compare."})},show_comparison:function(a){var b="<div class='modal box_containers' id='comparison_box'><div id='top_comparison_box' class='top_box row-fluid'><span>Images compared</span><span title='Close Window' id='close_comparison_box' class='pull-right'><span class='glyphicon glyphicon-remove close_box'></span></div>";b+="<span style='width:100%;background:#efefef;padding:1.5%;' class='pull-left'><button class='btn btn-sm btn-primary' id='image_compared_to_workspace'>Add to workspace</button></span><div class='box_container' id='images_compared_div'><div><img data-is_generated='true' data-workspace = '"+_self.workspaceImages.workspace+"' data-title='Region' id='image_result_compared' src='"+a.getImageDataUrl()+"' /></div></div></div>",_self.selectors.body.append(b),$("#comparison_box").show().animate({top:"20%",left:"24%",width:"50%",height:"70%",opacity:1,"z-index":400},{duration:250,complete:function(){$("#close_comparison_box").click(function(){$("#comparison_box").animate({top:"50%",left:"50%",width:"0%",height:"0%",opacity:0},{duration:250,complete:function(){$(this).remove()}})}),$("#image_result_compared").resizable({aspectRatio:!0}).parent().draggable({zIndex:0,scroll:!0,containment:"#images_compared_div"})}}).draggable({handle:".top_box"}),$("#image_compared_to_workspace").click(function(){var a=$("#image_result_compared");a.data("workspace",_self.workspaceImages.workspace),a.data("is-generated",!0),_self.letters.make_workable(a),$("#comparison_box").animate({width:"0%",height:"0%",opacity:0},{duration:250,complete:function(){$(this).remove()}})})},make_arrays:function(){var a=function(){for(var a=[],b=0;b<_self.letters.regions.length;b++)for(var c=0;c<_self.letters.regions[b].letters.length;c++)a.push(_self.letters.regions[b].letters[c].attr("id"));return a},b=function(){var a=[];return $.each(_self.letters.lettersSelected,function(){a.push(this.attr("id"))}),a},c={regions:a(),letters:b()};return c},"delete":function(){var a=this.make_arrays().regions,b=this.make_arrays().letters;if(!this.lettersSelected.length)return!1;for(var c=0;c<b.length;c++)for(var d=0;d<a.length;d++)if(b[c]==a[d])for(var e=0;e<_self.letters.regions.length;e++)for(var f=0;f<_self.letters.regions[e].letters.length;f++)if(_self.letters.regions[e].letters[f].attr("id")==b[c]&&(_self.letters.regions[e].letters.splice(f,1),f--,$("#"+b[c]).fadeOut().remove(),!_self.letters.regions[e].letters.length)){_self.letters.to_regions(),$("#manuscript_"+_self.letters.regions[e].id).fadeOut().remove(),_self.letters.regions.splice(e,1),e--;break}this.check_regions_length(),_self.letters.lettersSelected=[];var g=$("#selected_letters_number");g.html(this.lettersSelected.length+" selected")},to_workspace:function(){var a=_self.letters.regions;if(_self.letters.lettersSelected.clean(void 0),!this.lettersSelected.length)return!1;for(var b=0;b<this.lettersSelected.length;b++){for(var c=0;c<a.length;c++){for(var d=0;d<a[c].letters.length;d++)a[c].letters[d].attr("id")==this.lettersSelected[b].attr("id")&&(a[c].letters.splice(d,1),d--);a[c].letters.length||(a.splice(c,1),c--)}_self.letters.make_workable(this.lettersSelected[b]),_self.letters.lettersSelected.splice(b,1),b--}var e=$("#selected_letters_number");e.html(this.lettersSelected.length+" selected"),this.check_regions_length()},hide_box:function(){$("#comparison_box").fadeOut().remove()},export_as_xml:function(a){var b=_self.letters.regions,c="<?xml version='1.0' encoding='UTF-8'?>\n";c+="<regions>\n";for(var d=0;d<b.length;d++){c+="	<manuscript>\n",c+="		<id>"+b[d].id+"</id>\n",c+="		<title>"+b[d].title+"</title>\n";for(var e=0;e<b[d].letters.length;e++){var f=$(b[d].letters[e]);c+="			<letter>\n",c+="				<size>"+f.data("size")+"</size>\n",c+="				<id>"+f.attr("id")+"</id>\n",c+="				<src>"+f.attr("src")+"</src>\n",c+="				<title>"+f.data("title")+"</title>\n",c+="</letter>\n"}c+="	</manuscript>\n"}c+="</regions>";var g="text/xml",h=window.URL&&URL.createObjectURL.bind(URL)||window.webkitURL&&webkitURL.createObjectURL.bind(webkitURL)||window.createObjectURL;xmlFile=new Blob([c],{type:g});var i=document.createElement("a");if("xml"==a){i.download="letters.xml",i.id="clickable_link",i.href=h(xmlFile),i.textContent="Download XML",i.dataset.downloadurl=[g,i.download,i.href].join(":");var j=$("<div id='window_link'>");j.append(i);var k="<p><button id='close_window_link' style='margin-top:10%;' class='btn btn-danger btn-sm'>Close Window</button></p>";j.append(k),$("#window_link").length||(_self.selectors.body.append(j.fadeIn(300)),$("#close_window_link").on("click",function(){j.fadeOut(300).remove()}),$("#clickable_link").on("click",function(){j.fadeOut(300).remove()}))}else{var l="script.xsl";$.ajax({url:"transform_xml/",type:"POST",data:{xml:c,xsl_filename:l},success:function(a){i.download="digipal_images.html",i.id="clickable_link";var b=new Blob([a],{type:g});i.href=h(b),i.textContent="Download HTML",i.dataset.downloadurl=[g,i.download,i.href].join(":");var c=$("<div id='window_link'>");c.append(i);var d="<p><button id='close_window_link' style='margin-top:10%;' class='btn btn-danger btn-sm'>Close Window</button></p>";c.append(d),$("#window_link").length||(_self.selectors.body.append(c.fadeIn(300)),$("#close_window_link").on("click",function(){c.fadeOut(300).remove()}),$("#clickable_link").on("click",function(){c.fadeOut(300).remove()}))}})}},import_image:function(a){var b=a.target.files,c=b[0],d=new FileReader;d.onload=function(a){var b,d=a.target.result,e=$("<img>"),f=$("<div>");return f.data("from_pc",!0),f.data("is_letter",!0),f.attr("id",uniqueid()),f.data("size",this.width+","+this.height),e.attr("src",d),b=void 0!==c.name&&c.name.length>28?c.name.substr(0,25)+"...":c.name,f.data("title",b),f.append(e),_self.imagesBox.imagesSelected.push(f),_self.imagesBox.to_workspace(),_self.imagesBox.imagesSelected=[],!1},d.readAsDataURL(c)},import_xml:function(a){var b=a.target.files,c=b[0],d=new FileReader;d.onload=function(a){var b=a.target.result,c=new X2JS({escapeMode:!1,attributePrefix:"_",arrayAccessForm:"none"}),d=new X2JS(c),e=_self.utils.stringToXML(b),f=d.xml2json(e);_self.letters.importLetters(f.regions.manuscript),_self.letters.check_regions_length()},d.readAsText(c)},clean_array:function(a){for(var b=0;b<a.length;b++)"undefined"==typeof a[b].id&&(a.splice(b,1),b--);return a},importLetters:function(a){var b,c,d,e,f=a,g=[];if(f.hasOwnProperty(length)){for(var h=0;h<f.length;h++)for(b=f[h],d=0;d<b.letter_asArray.length;d++)c=$("<img>"),c.attr("class","letter"),c.data("manuscript",b.title),c.data("manuscript_id",b.id),c.attr("id",b.letter_asArray[d].id),c.attr("src",b.letter_asArray[d].src),c.data("size",b.letter_asArray[d].size),c.data("title",b.letter_asArray[d].title),g.push(c);for(e=0;e<g.length;e++)_self.letters.addLetter(g[e])}else{for(d=0;d<f.letter_asArray.length;d++)c=$("<img>"),c.attr("class","letter"),c.data("manuscript",f.title),c.data("manuscript_id",f.id),c.attr("id",f.letter_asArray[d].id),c.attr("src",f.letter_asArray[d].src),c.data("size",f.letter_asArray[d].size),c.data("title",f.letter_asArray[d].title),g.push(c);for(e=0;e<g.length;e++)_self.letters.addLetter(g[e])}}},this.menu={_self:this,open:!0,init:function(){this.buttons()},hide:function(){this.open=!1,$("#buttons").animate({left:"-10%"},300),$("#icon-up").css({"background-position":"-60px 0"})},show:function(){this.open=!0,$("#buttons").animate({left:"0"},300),$("#icon-up").css({"background-position":"-45px -15px"})},buttons:function(){$("#menu").click(function(){var a=_self.menu.open;a?_self.menu.hide():_self.menu.show()})}},this.minimap={_self:this,width:10,height:10,namespace:"mini_",images:[],add_to_minimap:function(a,b){var c=$("#"+a),d=c.offset(),e=d.top/$(window).height()*28,f=d.left/$(window).width()*20.5,g=c.css(["width","height"]),h=this.namespace+a,i=$("<img>");i.data("image",a),i.attr("id",h),i.attr("class","image_map"),i.attr("src",b),$("#overview").append(i),_self.workspaceImages.workspace==_self.defaults.workspace2&&(e=2*e,f=2*f),i.css({width:parseInt(g.width)/this.width+"px",height:parseInt(g.height)/this.height+"px",top:e,left:f}),_self.workspaceImages.workspace!=c.data("workspace")&&i.css({display:"none"}),this.make_scrollable(i),this.images.push(i)},make_scrollable:function(a){$(a).click(function(b){var c=a.data("image"),d=$("#"+c).offset();_self.selectors.html.animate({scrollTop:d.top-100,scrollLeft:d.left-100},800),_self.selectors.body.animate({scrollTop:d.top-100,scrollLeft:d.left-100},800),b.stopPropagation()})},update_mini_map:function(a){if("undefined"!=typeof a){var b,c,d;if(a.helper.hasClass("selected"))$.each($(".image_active"),function(){b=parseInt($(this).css("top"))/$(window).height()*28,c=parseInt($(this).css("left"))/$(window).width()*20.5,_self.workspaceImages.workspace==_self.defaults.workspace2&&(b=2*b,c=2*c),d={top:b,left:c},$("#"+_self.minimap.namespace+$(this).attr("id")).animate({left:d.left,top:d.top},0)});else{var e=a.helper;b=parseInt(e.css("top"))/$(window).height()*28,c=parseInt(e.css("left"))/$(window).width()*20.5,_self.workspaceImages.workspace==_self.defaults.workspace2&&(b=2*b,c=2*c),$("#"+_self.minimap.namespace+e.attr("id")).animate({left:c,top:b},0)}}},clean_minimap:function(){for(var a=this.images,b=0;b<a.length;b++){var c=$(a[b]).attr("id");$("#"+c).remove()}this.images=[]}},this.comments={_self:this,notes:[],open:!1,openFolder:!1,currentFolder:null,init:function(a,b,c,d,e,f,g){var h=$(".comment");if(h.length)h.focus();else{var i,j,k=$("body");a?(i=e,j=this.make_comment(i,b),k.append(j),$("#"+i).children(".comment_wrapper").children(".comment_content").html(c),$("#"+i).data("id",e),$("#"+i).data("image_note",b),$("#"+i).children(".comment_wrapper").children(".commentTitle").val(d),$("#"+i).animate({position:"fixed",top:g.top,left:g.left,height:f.height,width:f.width},100)):(i="note_"+b+"_"+uniqueid(),j=this.make_comment(i,b),k.append(j),d=$("#"+b).data("title"),$("#"+i).data("image_note",b),$("#"+i).data("title",d)),$("#"+i).draggable({handle:".top_comment",cursor:"move",stack:"div",appendTo:"body",zIndex:1e3}).resizable({maxHeight:600,maxWidth:700,minHeight:300,minWidth:350}),this.buttons(),$("#notes_alert").hide().html("")}},buttons:function(){$(".removeComment").click(function(){for(var a=_self.comments.notes,b=$(this).parent().parent(".comment"),c=0;c<a.length;c++)for(var d=0;d<a[d].notes.length;d++)a[c].notes[d].id==b.data("id")&&(_self.comments.notes[c].notes.splice(d,1),d--);$("#stickable_note_"+b.data("id")).length&&$("#stickable_note_"+b.data("id")).remove(),b.fadeOut().remove();var e=$("#notes_alert");_self.comments.notes.length?e.hide().html(""):e.show().html("No notes created"),_self.comments.update_notes(),$.fn.notify({text:"Note successfully removed",type:"success",close_button:!0,position:{top:"8%",left:"79%"}})}),$(".minimizeNote").click(function(){_self.comments.minimizeNote($(this).parent().parent(".comment")),_self.comments.check_notes()});var a=function(a){var b=document.queryCommandState(a);return b};$(".comment_content").on("keyup",function(){a("bold")?$("#bold").addClass("active"):$("#bold").removeClass("active"),a("italic")?$("#italic").addClass("active"):$("#italic").removeClass("active"),a("underline")?$("#underline").addClass("active"):$("#underline").removeClass("active"),a("underline")?$("#underline").addClass("active"):$("#underline").removeClass("active"),a("insertUnorderedList")?$("#list").addClass("active"):$("#list").removeClass("active"),a("formatBlock")?$("#heading").addClass("active"):$("#heading").removeClass("active")}),$("#bold").on("click",function(){document.execCommand("bold",!1,null)}),$("#italic").on("click",function(){document.execCommand("italic",!1,null)}),$("#underline").on("click",function(){document.execCommand("underline",!1,null)}),$("#link").on("click",function(){var a=document.getSelection();document.execCommand("insertHTML",!1,"<a href='"+a+"'>"+a+"</a>")}),$("#list").on("click",function(){document.execCommand("insertUnorderedList",!1,null)}),$("#heading").on("click",function(){document.execCommand("formatBlock",!1,"<h3>")})},check_notes:function(){if(1==_self.select_group.imagesSelected.length){var a=_self.select_group.imagesSelected[0],b=_self.comments.notes,c=$("#createComment");if(!$("#open_notes").length)for(var d=0;d<b.length;d++)if(b[d].image==a.attr("id")){var e=$("<button class = 'btn btn-sm btn-warning' id='open_notes'>Open notes</button>");c.after(e.hide().fadeIn());break}$("#open_notes").unbind().on("click",function(){_self.comments.open_notes(a)})}},minimizeNote:function(a){var b,c,d=a.position();a.hasClass("readable_comment")?(b=a.children(".readable_comment_wrapper").children(".readable_comment_content").html(),c=a.children(".readable_comment_wrapper").children(".readable_comment_commentTitle").val()):(b=a.children(".comment_wrapper").children(".comment_content").html(),c=a.children(".comment_wrapper").children(".commentTitle").val());var e=a.attr("id"),f=a.data("image_note"),g=a.data("title"),h={height:a.css("height"),width:a.css("width")},i={title:c,content:b,position:d,id:e,image:f,image_title:g,size:h};$("#stickable_note_"+e).html(b);for(var j=!1,k=0;k<this.notes.length;k++){if(this.notes[k].image==f){j=!1;break}j=!0}if(j||!this.notes.length){var l={image:i.image,title:i.image_title,notes:[i]};this.notes.push(l)}else{j=!1;a:for(k=0;k<this.notes.length;k++)for(var m=0;m<this.notes[k].notes.length;m++){if(this.notes[k].notes[m].id==e){j=!1;break a}j=!0;break a}if(j){for(k=0;k<this.notes.length;k++)if(this.notes[k].image==f){this.notes[k].notes.push(i);break}}else this.notes[k].notes[m].size=h,this.notes[k].notes[m].content=b,this.notes[k].notes[m].title=c,this.notes[k].notes[m].position=d}var n,o=$("#notes");if(this.open)if(o.find(".note:last-child").length){var p=o.find(".note:last-child").position();n={top:p.top,left:p.left+50}}else n={top:o.position().top,left:o.position().left+50};else n={top:$("#notes_button").position().top,left:"2%"};if(this.openFolder){var q="";this.currentFolder==i.image&&(q+=this.create_note(i.title,i.id,i.content)),$("#notes_container").append(q),_self.comments.events_on_notes()}a.animate({top:n.top,left:n.left,width:0,height:0,opacity:0},{duration:250,complete:function(){$(this).hide().remove()}}),this.update_notes()},make_comment:function(a,b){var c="<div class='comment' id='"+a+"' data-image = '"+b+"'>";return c+="<div class='top_comment'>",c+="<button class='btn btn-sm btn-danger removeComment' title='Delete Note'><span class='glyphicon glyphicon-remove'></span> Delete</button>",c+="<div class='pull-right minimizeNote' title='Save note'><button class='btn btn-success btn-sm'><span style='font-weight:bold;color:white;cursor:pointer;' class='glyphicon glyphicon-ok'></span> Save</button></div></div>",c+="<div class='comment_wrapper'>",c+="<input class='commentTitle' class='hidden' placeholder='Title ...' />",c+="<div class='comment_content' contenteditable></div>",c+=' <div id="rich_buttons" class="btn-group" data-toggle="buttons-checkbox"><button type="button" id="bold" class="btn btn-sm" title="bold">B</button><button type="button" id="italic" class="btn btn-sm" title="italic">I</button><button type="button" id="underline" class="btn btn-sm" title="underline">U</button><button type="button" id="heading" class="btn btn-sm" title="heading"><span class="glyphicon glyphicon-header"></button><button type="button" id="link" class="btn btn-sm" title="link"><span class="glyphicon glyphicon-globe"></button><button type="button" id="list" class="btn btn-sm" title="list"><span class="glyphicon glyphicon-list"></button></div></div>'},makeReadableComment:function(a,b,c,d){var e="<div class='readable_comment' id='"+a+"' data-image = '"+b+"' data-image_note = '"+b+"'>";return e+="<span class='pull-right minimizeNote' title='Minimize note' style='margin:2%;'><span style='font-weight:bold;color:#444;font-size:15px;cursor:pointer;margin:0.5%;' class='glyphicon glyphicon-remove'></span></span>",e+="<div class='readable_comment_wrapper'>",e+="<span class='readable_comment_commentTitle' class='hidden'>"+c+"</span>",e+="<div class='readable_comment_content'>"+d+"</div></div</div>"},events_on_notes:function(){var a=this.notes;$(".note .remove_comment_from_box").click(function(){for(var b=$(this).closest(".note"),c=0;c<a.length;c++)for(var d=0;d<a[c].notes.length;d++)a[c].notes[d].id==b.data("id")&&(_self.comments.notes[c].notes.splice(d,1),$("#stickable_note_"+b.data("id")).length&&$("#stickable_note_"+b.data("id")).remove(),d--);$(b).stop().animate({position:"absolute",width:"0px",height:"0px",backgroundColor:"red",opacity:0},{duration:300,complete:function(){$(this).hide().remove()}});var e=$("#notes_alert");a.length?e.hide().html(""):(e.fadeIn().html("No notes created"),_self.comments.es()),_self.comments.update_notes()}),$(".edit_comment_from_box").unbind().click(function(){_self.comments.show_comment($(this))}),$(".read_note").unbind().click(function(){_self.comments.read_note($(this))}),$(".stick_to_workspace").on("click",function(){_self.comments.stick($(this))})},stick:function(a){for(var b=this.notes,c=a.closest(".note"),d=0;d<b.length;d++)for(var e=0;e<b[d].notes.length;e++)if(b[d].notes[e].id==c.data("id")){var f=b[d].notes[e].id,g=b[d].notes[e].image,h=b[d].notes[e].title,i=b[d].notes[e].content;_self.comments.create_stickable_note(f,g,h,i)}_self.comments.hide_notes()},create_stickable_note:function(a,b,c,d){var e=$('<span class="stickable_note" id="stickable_note_'+a+'" contenteditable>'),f=this.notes,g=d;$("#stickable_note_"+a).length||(e.data({id:a,image:b,title:c}).append(d).draggable({alsoDrag:!1,delay:100}).on("click",function(){$(this).focus()}).on("dblclick",function(a){var b,c,d;if($(this).hasClass("selected")){if($(this).data("group")&&$(this).data("group").length)for(b=$(this).data("group"),d=0;d<b.length;d++)c=$("#"+b[d]),_self.select_group.deselect(c);if($(this).data("group_notes")&&$(this).data("group_notes").length)for(b=$(this).data("group_notes"),d=0;d<b.length;d++)c=$("#"+b[d]),c.removeClass("selected");$(this).removeClass("selected"),e.draggable({delay:100,alsoDrag:!1}),$(this).blur()}else{if($(this).data("group")&&$(this).data("group").length)for(b=$(this).data("group"),d=0;d<b.length;d++)c=$("#"+b[d]),_self.select_group.select_image(c);if($(this).data("group_notes")&&$(this).data("group_notes").length)for(b=$(this).data("group_notes"),d=0;d<b.length;d++)c=$("#"+b[d]),c.addClass("selected");$(this).addClass("selected"),e.draggable({alsoDrag:".selected",delay:100}),$(this).focus()}_self.toolbar.refresh(),a.stopPropagation()}).on("contextmenu",function(){return!1}).on("blur",function(){if(g!=$(this).html()){for(var b=0;b<f.length;b++)for(var c=0;c<f[b].notes.length;c++)f[b].notes[c].id==a&&(f[b].notes[c].content=$(this).html());g=$(this).html()}}).css({top:$("#"+b).position().top,left:$("#"+b).position().left}).resizable(),$(_self.workspaceImages.workspace).append(e))},hide_notes:function(){var a=$("#notes_button");a.show();var b=a.position();$("#notes").animate({top:$("#buttons").position().top+b.top,left:"2%",width:"0%",height:"0%",opacity:0},{duration:250,complete:function(){$(this).hide(),a.tooltip({placement:"right",trigger:"hover"})}}),this.open=!1},create_note:function(a,b,c){var d="<div class = 'note' data-id = '"+b+"'><p style='padding:0' class='note_box_title col-lg-9 col-lm-9 col-xs-9'>"+a+"</p>";return d+="<span data-toggle='tooltip' data-placement='bottom' title='Edit Note' class='glyphicon glyphicon-pencil edit_comment_from_box'></span> ",d+="<span data-toggle='tooltip' data-placement='bottom' title='Stick to workspace' class='glyphicon glyphicon-send stick_to_workspace'></span>",d+=" <span data-toggle='tooltip' data-placement='bottom' title='Delete Note' class='glyphicon glyphicon-remove remove_comment_from_box'></span></p><div class='note_box_content'>"+c+"</div></div>"},open_notes:function(a){var b=$("<div>");if(b.data("image",a.attr("id")),b.data("image_title",a.data("title")),this.open&&!this.openFolder)this.openFolder_notes(b);else{if(this.open&&this.openFolder&&this.currentFolder==a.attr("id"))return;this.show_notes(),this.openFolder_notes(b)}},read_note:function(a){for(var b=this.notes,c=a.parent().parent(".note"),d=0;d<b.length;d++)for(var e=0;e<b[d].notes.length;e++)if(b[d].notes[e].id==c.data("id")){var f=b[d].notes[e].id,g=b[d].notes[e].image,h=b[d].notes[e].title,i=b[d].notes[e].content,j=b[d].notes[e].position,k=b[d].notes[e].size;$(c).animate({top:j.top,left:j.left,width:k.width,height:k.height,opacity:1},{duration:400,complete:function(){$(this).hide();var a=_self.comments.makeReadableComment(f,g,h,i);_self.selectors.body.append(a),$(".readable_comment").draggable().resizable().find(".minimizeNote").click(function(){var a=$(this).parent(".readable_comment");_self.comments.minimizeNote(a)})}})}},show_comment:function(a){if($(".comment").length)$.fn.notify({type:"error","close-button":!0,position:{top:"8%",left:"80%"},text:"A note window is already open on the workspace."});else for(var b=this.notes,c=a.closest(".note"),d=0;d<b.length;d++)for(var e=0;e<b[d].notes.length;e++)if(b[d].notes[e].id==c.data("id")){var f=b[d].notes[e].id,g=b[d].notes[e].image,h=b[d].notes[e].title,i=b[d].notes[e].content,j=b[d].notes[e].position,k=b[d].notes[e].size;$(c).animate({top:j.top,left:j.left,width:k.width,height:k.height,opacity:1},{duration:400,complete:function(){$(this).hide(),_self.comments.init(!0,g,i,h,f,k,j)}})}},openFolder_notes:function(a){this.openFolder=!0,this.currentFolder=a.data("image");var b=$("<div>"),c=(a.data("image"),$("#breadcrumb_notes")),d=$("#notes_alert"),e=$("#notes_container");if(b.attr({"class":"breadcrumb",display:"none",id:"breadcrumb_notes"}).css({"border-bottom":"1px solid #ddd"}),!c.length){$("#breadcrumb_notes_container").append(b);var f="<li><a class='link' id='to_notes'>Notes</a></li>";f+="<li class='active'>"+a.data("image_title")+"</li>",f+="<li class='pull-right no-before'><span style='cursor:pointer;' id='to_notes_icon' class='glyphicon glyphicon-arrow-left'></span></li>",b.html(f).show()}$("#to_notes").click(function(){_self.comments.back_to_notes()}),$("#to_notes_icon").click(function(){_self.comments.back_to_notes()});for(var g="",h=0;h<this.notes.length;h++)if(this.notes[h].image==a.data("image"))for(var i=0;i<this.notes[h].notes.length;i++)g+=this.create_note(this.notes[h].notes[i].title,this.notes[h].notes[i].id,this.notes[h].notes[i].content);e.html(g),_self.comments.events_on_notes(),_self.comments.notes.length?d.hide().html(""):d.show().html("No notes created"),e.find('[data-toggle="tooltip"]').tooltip(),$(".note_folders").fadeOut(100).remove()},back_to_notes:function(){$("#breadcrumb_notes").add(".note").hide().remove(),this.openFolder=!1,this.currentFolder=null,$("#notes_container").html(""),this.update_notes()},update_notes:function(){var a=this.notes,b=$(".note_folders");if(!this.openFolder)for(var c=0;c<a.length;c++){var d=$(b[c]).data("image");if(a[c].image!=d){var e=$("<div class='note_folders col-lg-3'><img src='/static/img/folder-documents.png' /><span class='note_folders_title'></span></div>");e.data("image",a[c].image),e.data("image_title",a[c].title),e.children("span").html(a[c].title),$("#notes_container").append(e),e.click(function(){_self.comments.openFolder_notes($(this))})}}this.clean_notes_array(),this.check_notes()},show_notes:function(){var a=$("#notes_button").position();$("#notes").css({top:$("#buttons").position().top+a.top,left:"2%"}).show().animate({top:"5%",left:"20%",width:"60%",height:"90%",opacity:1,"z-index":400},{duration:250,complete:function(){$("#notes_button").hide(),$("#notes_button").tooltip({placement:"right",trigger:"hover"}),$("#close_notes").click(function(){_self.comments.hide_notes()})}}).draggable({handle:".top_box"}),_self.comments.notes.length?$("#notes_alert").fadeOut().html(""):$("#notes_alert").fadeIn().html("No notes created"),this.open=!0},clean_notes:function(){$(".note").remove(),this.notes=[]},clean_notes_array:function(){for(var a=this.notes,b=!1,c=0;c<a.length;c++)a[c].notes.length?b=!1:(a[c].image==_self.select_group.imagesSelected[0].attr("id")&&$("#open_notes").fadeOut(300).remove(),b=!0,$(".note_folders").data("image",a[c].image).remove(),_self.comments.notes.splice(c,1),c--);b&&this.openFolder&&this.back_to_notes()}},this.select_group={_self:this,imagesSelected:[],deselect:function(a){a.find(".ui-wrapper").css("box-shadow","0px 0px 10px 3px #444"),a.removeClass("selected"),a.data("selected",!1),a.draggable({alsoDrag:!1}),a.find("img").resizable("destroy");for(var b=0;b<this.imagesSelected.length;b++)$(this.imagesSelected[b]).attr("id")==a.attr("id")&&(this.imagesSelected.splice(b,1),b--);_self.toolbar.refresh()},select_image:function(a){a.addClass("selected"),a.data("selected",!0),a.draggable({alsoDrag:".selected"}),a.find("img").resizable({aspectRatio:!0,animate:!1,alsoResize:".image_active.selected, .image_active.selected > div, .image_active.selected > div > img",resize:function(a,b){return _self.select_group.imagesSelected.length<=1?$("#"+_self.minimap.namespace+b.element.parent().attr("id")).animate({width:parseInt($(this).css("width"))/_self.minimap.width+"px"},10):$.each($(".selected"),function(){$("#"+_self.minimap.namespace+$(this).attr("id")).animate({width:parseInt($(this).children().css("width"))/_self.minimap.width+"px",height:parseInt($(this).children().css("height"))/_self.minimap.height+"px"},10)
}),_self.toolbar.refreshSize(),a.stopPropagation(),!1}}),_self.select_group.imagesSelected.push(a),a.find(".ui-wrapper").css("boxShadow","0px 0px 30px rgba(255, 246, 9, 1)"),_self.toolbar.refresh()},select:function(a){var b=!1;if(a.hasClass("selected")){if(a.data("group")&&a.data("group").length){b=!0;for(var c=a.data("group"),d=0;d<c.length;d++){var e=$("#"+c[d]);this.deselect(e)}this.deselect(a)}else b=!1,this.deselect(a);if(a.data("group_notes")&&a.data("group_notes").length){b=!0;for(var c=a.data("group_notes"),d=0;d<c.length;d++){var e=$("#"+c[d]);e.removeClass("selected")}}}else{if(b=!1,_self.toolbar.create(null,!0),a.data("group")&&a.data("group").length){b=!0;for(var c=a.data("group"),d=0;d<c.length;d++){var e=$("#"+c[d]);this.select_image(e)}this.select_image(a)}else this.select_image(a);if(a.data("group_notes")&&a.data("group_notes").length){b=!0;for(var c=a.data("group_notes"),d=0;d<c.length;d++){var e=$("#"+c[d]);e.addClass("selected")}}_self.toolbar.show()}b?_self.toolbar.selectors.buttons.group.html("Ungroup").addClass("ungroup"):_self.toolbar.selectors.buttons.group.html("Group").removeClass("ungroup"),_self.toolbar.refresh()},group:function(){var a=$(".stickable_note.selected"),b=[],c=[];if(_self.toolbar.selectors.buttons.group.hasClass("ungroup")){for(var d=0;d<this.imagesSelected.length;d++)this.imagesSelected[d].data("group",[]).data("group_notes",[]);a.each(function(){$(this).data("group",[]).data("group_notes",[])}),_self.toolbar.selectors.buttons.group.html("Group").removeClass("ungroup")}else{for(var d=0;d<this.imagesSelected.length;d++)b.push(this.imagesSelected[d].attr("id"));a.each(function(){c.push($(this).attr("id"))});for(var d=0;d<this.imagesSelected.length;d++){var e=this.imagesSelected[d],f=e.attr("id"),g=(e.data("group"),b.slice(0));g=g.filter(function(a){return a!==f}),e.data("group",g).data("group_notes",c)}a.each(function(){$(this).data("group",b).data("group_notes",c)}),_self.toolbar.selectors.buttons.group.html("Ungroup").addClass("ungroup")}}},this.toolbar={_self:this,selectors:null,init:function(a){this.default_options={id:"toolbar",container:"body"},$.extend(this.default_options,a),this.create(null,!1)},exists:function(){return $("#toolbar").length},is_visible:function(){return"block"==$("#toolbar").css("display")},create:function(a,b){return this.exists()&&this.is_visible()?!1:!this.exists()&&$(".image_active").length||!b?(_self.selectors.body.append('<div id="toolbar"></div>'),this.toolbox=$("#toolbar"),this.toolbox.dblclick(function(a){return a.stopPropagation(),!1}),this.makeTools(),b&&this.toolbox.show(),void 0):(console.warn("Toolbar not initialized, or no images on workspace"),!1)},disable:function(){$.each(this.selectors.sliders,function(){this.hasClass("ui-slider")&&this.slider("option","disabled",!0)}),$.each(this.selectors.buttons,function(){this.attr("disabled","disabled")}),this.selectors.title.html("No images selected"),this.selectors.buttons.crop_image.fadeOut(),this.selectors.buttons.cropButton.removeClass("active"),this.selectors.buttons.selectAll.attr("disabled",!1).removeClass("disabled")},enable:function(){var a=["group","createComment","compare_toolbar","crop_button"];$.each(this.selectors.sliders,function(){this.slider("option","disabled",!1)}),$.each(this.selectors.buttons,function(){a.indexOf(this.attr("id"))<0&&!this.hasClass("crop_button")&&this.attr("disabled",!1).removeClass("disabled")})},makeSelectors:function(){_self.toolbar.selectors={sliders:{opacity:$("#slider"),brightness:$("#slider_brightness"),rotate:$("#slider_rotate"),size:$("#slider_size")},buttons:{grayscale:$("#grayscale"),invert:$("#invert"),contrast:$("#contrast"),createComment:$("#createComment"),crop_image:$("#crop_image"),compare:$("#compare_toolbar"),cropButton:$(".crop_button"),selectAll:$("#select_all"),deselectAll:$("#deselect_all"),alignButton:$("#align"),alignButtons:$(".align"),reset:$("#reset_image"),remove:$("#removeImage"),clone:$("#clone"),flipx:$("#flip-x"),flipy:$("#flip-y"),group:$("#group")},title:$("#name_image")}},makeTools:function(){this.toolbox.load("/static/js/tools_template.html",function(){_self.toolbar.makeSelectors(),_self.toolbar.stylize(),_self.toolbar.buttons(),void 0===document.body.style.webkitFilter&&_self.toolbar.selectors.buttons.contrast.remove(),_self.crop.init()})},opacity:function(){var a=this.selectors.sliders.opacity;a.slider({disabled:!0,slide:function(a,b){if(_self.images_on_workspace().length){var c=b.value/100;$.each(_self.select_group.imagesSelected,function(){var a=$("#"+_self.minimap.namespace+this.attr("id"));this.find("img").css("opacity",c),a.css("opacity",c)})}}})},brightness:function(){var a=this.selectors.sliders.brightness;a.slider({min:100,max:300,disabled:!0,value:200,slide:function(a,b){$.each(_self.select_group.imagesSelected,function(){if(_self.images_on_workspace().length){var a=$("#"+_self.minimap.namespace+this.attr("id"));void 0!==document.body.style.webkitFilter?(this.css("-webkit-filter","brightness("+b.value/2+"%)"),a.css("-webkit-filter","brightness("+b.value/2+"%)")):(this.css("polyfilter","brightness("+b.value/2+"%)"),a.css("-webkit-filter","brightness("+b.value/2+"%)"))}})}})},rotate:function(){var a=this.selectors.sliders.rotate;a.slider({min:-180,max:180,disabled:!0,value:0,step:6,slide:function(a,b){$.each(_self.select_group.imagesSelected,function(){var a=$("#"+_self.minimap.namespace+this.attr("id"));this.css("transform","rotate("+b.value+"deg)"),a.css("transform","rotate("+b.value+"deg)")})}})},flip:function(a,b){var c=a.hasClass("active"),d="flippedY";"x"==b&&(d="flippedX"),$.each(_self.select_group.imagesSelected,function(){c?$(this).find("img").removeClass(d):$(this).find("img").hasClass(d)||$(this).find("img").addClass(d)}),c?a.removeClass("active"):a.addClass("active")},apply_filter:function(a,b,c){var d=_self.select_group.imagesSelected;void 0===c||c?a.hasClass("active")?$.each(d,function(){var c=$("#"+_self.minimap.namespace+this.attr("id"));this.find("img").hasClass(b)&&(this.find("img").removeClass(b),c.removeClass(b)),a.removeClass("active")}):$.each(d,function(){var c=$("#"+_self.minimap.namespace+this.attr("id"));this.find("img").hasClass(b)||(this.find("img").addClass(b),c.addClass(b)),a.addClass("active")}):$.each(d,function(){var c=$("#"+_self.minimap.namespace+this.attr("id"));this.find("img").removeClass(b),c.removeClass(b),a.removeClass("active")})},size:function(){var a=this.selectors.sliders.size;a.slider({min:10,max:2e3,disabled:!0,value:180,slide:function(a,b){$.each(_self.select_group.imagesSelected,function(){var a=b.value;this.children().css({width:a}),this.css({width:a}),this.find("img").css({width:a});var c=this.offset();(c.top<$(window).scrollTop()||c.left<$(window).scrollLeft())&&this.animate({top:$(window).scrollTop()+100,left:$(window).scrollLeft()+100},150),$("#"+_self.minimap.namespace+this.attr("id")).animate({width:parseInt(this.find("img").css("width"))/_self.minimap.width+"px",height:parseInt(this.find("img").css("height"))/_self.minimap.height+"px"},10)})}}),this.refreshSize()},compare_toolbar:function(){var a=$(".selected");if(2==a.length){var b=$(a[0]).find("img"),c=$(a[1]).find("img"),d=[b.attr("src"),c.attr("src")];$.ajax({type:"POST",url:"return_base64/",data:{images:JSON.stringify(d)},success:function(a){var b=$("<img>"),c=$("<img>");b.attr({src:a[0],id:"image_compare1"}).css({display:"none"}),c.attr({src:a[1],id:"image_compare2"}).css({display:"none"}),_self.selectors.body.append(b),_self.selectors.body.append(c);var d=document.getElementById("image_compare1"),e=document.getElementById("image_compare2");resemble(d).compareTo(e).onComplete(function(a){result=a}).ignoreAntialiasing(),b.remove(),c.remove(),_self.letters.show_comparison(result)}})}else $.fn.notify({type:"error","close-button":!0,text:"Choice two images to compare."})},clone:function(){for(var a=uniqueid(),b=_self.select_group.imagesSelected,c=(_self.workspaceImages.workspace,0);c<b.length;c++){var d=$(b[c]),e=d.clone().attr("id",a);e.data("is_clone",!0),e.data("title",d.data("title")+" (clone)"),e.data("original",d.attr("id")),e.data("selected",!1),e.removeClass("selected"),e.css({position:"absolute",left:d.position().left+d.find("img").css("width")+10,top:d.css("top")}),e.find("img").unwrap().removeClass("ui-resizable"),e.find(".ui-resizable-handle").remove(),_self.imagesBox.imagesSelected.push(e)}_self.imagesBox.to_workspace()},selectAll:function(){var a=$(_self.workspaceImages.workspace).find(".image_active");_self.select_group.imagesSelected=[],$.each(a,function(){$(this).addClass("selected"),$(this).data("selected",!0),$(this).draggable({alsoDrag:".selected"}),$(this).find("img").resizable({aspectRatio:!0,animate:!0,alsoResize:"image_active.selected, image_active.selected > div, image_active.selected > div > img",resize:function(a,b){return _self.select_group.imagesSelected.length<=1?$("#"+_self.minimap.namespace+b.element.parent().attr("id")).animate({width:parseInt($(this).css("width"))/_self.minimap.width+"px"},10):$.each($(".selected"),function(){$("#"+_self.minimap.namespace+$(this).attr("id")).animate({width:parseInt($(this).children().css("width"))/_self.minimap.width+"px",height:parseInt($(this).children().css("height"))/_self.minimap.height+"px"},10)}),_self.toolbar.refreshSize(),a.stopPropagation(),!1}}),$(this).find(".ui-wrapper").css("boxShadow","0px 0px 30px rgba(255, 246, 9, 1)"),_self.select_group.imagesSelected.push($(this))});var b=$("#open_notes");b.length&&b.fadeOut().remove(),this.refresh();var c=_self.toolbar.selectors.buttons.createComment;1==_self.select_group.imagesSelected.length?(_self.toolbar.selectors.buttons.cropButton.removeClass("disabled"),c.removeClass("disabled").click(function(){var a=_self.select_group.imagesSelected[0].attr("id");_self.comments.init(!1,a,!1,!1,!1,!1,!1,!1)}),_self.comments.check_notes()):(_self.toolbar.selectors.buttons.cropButton.addClass("disabled"),c.addClass("disabled"),b.fadeOut().remove())},deselectAll:function(){var a=$(_self.workspaceImages.workspace).find(".image_active.selected");$.each(a,function(){_self.select_group.deselect($(this))}),$("#open_notes").fadeOut().remove(),this.refresh()},reset:function(){$.each(_self.select_group.imagesSelected,function(){var a=($("#"+_self.minimap.namespace+this.attr("id")),this.data("size").split(","),"180px"),b="auto";this.data("external")&&(a=this.data("size").split(",")[0]/2,b=this.data("size").split(",")[1]/2),this.children().css({width:a,height:"auto"}),this.css(void 0!==document.body.style.webkitFilter?{width:a,height:b,"-webkit-transform":"rotate(0deg)",transform:"rotate(0deg)","-webkit-filter":"brightness(100%)"}:{width:a,height:b,"-moz-transform":"rotate(0deg)","-o-transform":"rotate(0deg)","-ms-transform":"rotate(0deg)",transform:"rotate(0deg)",polyfilter:"brightness(100%)"}),this.find("img").css({width:a,height:b,"-webkit-transform":"rotateX(0deg) rotateY(0deg)","-moz-transform":"rotateX(0deg) rotateY(0deg)","-o-transform":"rotateX(0deg) rotateY(0deg)","-ms-transform":"rotateX(0deg) rotateY(0deg)",transform:"rotateX(0deg) rotateY(0deg)",opacity:1});var c=this.offset();(c.top<$(window).scrollTop()||c.left<$(window).scrollLeft())&&this.animate({top:$(window).scrollTop()+100,left:$(window).scrollLeft()+100},150),$("#"+_self.minimap.namespace+this.attr("id")).animate({width:parseInt(this.find("img").css("width"))/40+"px",height:parseInt(this.find("img").css("height"))/30+"px"},10),_self.toolbar.selectors.buttons.grayscale.prop("checked",!1)}),this.refresh(),this.refreshSize(),this.apply_filter(_self.toolbar.selectors.buttons.grayscale,"grayscale",!1),this.apply_filter(_self.toolbar.selectors.buttons.invert,"invert",!1),this.apply_filter(_self.toolbar.selectors.buttons.contrast,"contrast",!1)},stylize:function(){this.toolbox.addClass("box").draggable({stack:".box",cursor:"move",appendTo:"body"})},show:function(){var a=$("#button_toolbar");a.tooltip("hide").fadeOut().remove(),this.last_style||(this.last_style=this.toolbox.css(["top","left","width","height","opacity"])),this.toolbox.show().animate({top:this.last_style.top,left:this.last_style.left,width:this.last_style.width,height:this.last_style.height,opacity:this.last_style.opacity},250)},hide:function(){var a=$("#buttons");$("#button_toolbar").length||a.prepend("<div data-toggle='tooltip' data-placement='right' data-container='body' title='Show Tools Box' id='button_toolbar' class='glyphicon glyphicon-cog'></div>");var b=$("#button_toolbar");this.last_style=this.toolbox.css(["top","left","width","height","opacity"]),this.toolbox.animate({position:"absolute",top:a.position().top+30,left:"2%",width:0,height:0,opacity:0},{duration:250,complete:function(){$(this).hide(),b.tooltip({placement:"right",trigger:"hover"}).click(function(){_self.toolbar.show()})}})},buttons:function(){$("#closeToolbar").click(function(){_self.toolbar.hide($(this)),this.is_hidden=!0}),this.selectors.buttons.reset.click(function(){_self.toolbar.reset()}),this.selectors.buttons.grayscale.click(function(){_self.toolbar.apply_filter($(this),"grayscale")}),this.selectors.buttons.invert.click(function(){_self.toolbar.apply_filter($(this),"invert")}),void 0!==document.body.style.webkitFilter&&this.selectors.buttons.contrast.click(function(){_self.toolbar.apply_filter($(this),"contrast")}),this.selectors.buttons.alignButtons.click(function(){_self.align.align($(this).text())}),this.selectors.buttons.compare.click(function(){_self.toolbar.compare_toolbar()}),this.selectors.buttons.remove.click(function(){$.each(_self.select_group.imagesSelected,function(){$("#"+_self.minimap.namespace+$(this).attr("id")).remove(),_self.toolbar.disable(),$(this).remove()}),_self.select_group.imagesSelected=[];var a=$("#toolbar .popover");a.length&&a.remove()}),this.selectors.buttons.crop_image.click(function(){_self.crop.get_image()}),this.selectors.buttons.selectAll.click(function(){_self.toolbar.selectAll()}),$("#clone").click(function(){_self.toolbar.clone()}),this.selectors.buttons.deselectAll.click(function(){_self.toolbar.deselectAll()}),this.selectors.buttons.flipx.click(function(){_self.toolbar.flip($(this),"x")}),this.selectors.buttons.flipy.click(function(){_self.toolbar.flip($(this),"y")}),this.selectors.buttons.group.click(function(){_self.select_group.group()}),this.selectors.buttons.createComment.click(function(){var a=_self.select_group.imagesSelected[0].attr("id");_self.comments.init(!1,a,!1,!1,!1,!1,!1,!1)}),this.opacity(),this.brightness(),this.rotate(),this.size()},refreshSize:function(){var a;_self.select_group.imagesSelected.length&&($.each(_self.select_group.imagesSelected,function(){a=parseInt(this.find("img").css("width"))}),this.selectors.sliders.size.slider("option","value",a))},refresh:function(){var a=$("#images_group");a.popover("destroy"),this.selectors||this.makeSelectors(),$.each(_self.select_group.imagesSelected,function(a,b){var c=function(){var a={};String.prototype.getNums=function(){var a=/[+-]?((\.\d+)|(\d+(\.\d+)?)([eE][+-]?\d+)?)/g,b=this.match(a)||[];return b.map(Number)};var c,d=function(a){var b;if("none"!==a){var c=a.split("(")[1].split(")")[0].split(","),d=c[0],e=c[1];b=Math.round(Math.atan2(e,d)*(180/Math.PI))}else b=0;return 0>b?b+=360:b},e=_self.toolbar.selectors.title;if(_self.images_on_workspace().length){c=b.data("title"),_self.select_group.imagesSelected.length>1?(a.name="<span id='images_group'>"+_self.select_group.imagesSelected.length+" images selected</span>",e.html(a.name),$("#images_group").popover({trigger:"click",placement:"right",title:"Images selected",container:"#toolbar",html:!0,content:function(){var a="";return $.each(_self.select_group.imagesSelected,function(){var b=this.offset(),c=b.top,d=b.left,e=function(a){return a.length>25?a.substr(0,25)+"...":a};a+="<p data-image = '"+this.attr("id")+"'",a+="class='images_selected row-fluid'>",a+="<span data-coords = "+c+","+d+" class = 'title-image-selected col-lg-9'",a+=" title = 'Go to "+this.data("title")+"'>"+e(this.data("title"))+"</span>",a+=" <span data-image = "+this.attr("id")+" title='Hide Image' class='icons-tool col-lg-1 hide-image glyphicon glyphicon-eye-close'></span> <span data-image = '"+this.attr("id")+"'",a+="title='Delete Image' class='icons-tool col-lg-1 delete-image glyphicon glyphicon-trash'></span></p>"}),a}}),$("#images_group").on("shown.bs.popover",function(){function a(){var a=$(this).data("image");$("#"+a).fadeOut(),$(this).removeClass("glyphicon-eye-close"),$(this).removeClass("hide-image"),$(this).addClass("glyphicon-eye-open"),$(this).attr("title","Show Image"),$(this).addClass("show-image"),$(this).unbind(),$(this).on("click",b)}function b(){var b=$(this).data("image");$("#"+b).fadeIn(),$(this).removeClass("glyphicon-eye-open"),$(this).removeClass("show-image"),$(this).addClass("glyphicon-eye-close"),$(this).attr("title","Hide Image"),$(this).addClass("hide-image"),$(this).unbind(),$(this).on("click",a)}$(".images_selected .title-image-selected").click(function(){var a=$(this).data("coords").split(",");$("html, body").animate({scrollTop:a[0]-100,scrollLeft:a[1]-100},500)}),$(".hide-image").on("click",a),$(".title-image-selected").hover(function(){var a=$(this).parent().data("image");$("#"+_self.minimap.namespace+a).animate({"box-shadow":"0px 0px 8px red"},50)}),$(".images_selected").mouseout(function(){var a=$(this).data("image");$("#"+_self.minimap.namespace+a).animate({"box-shadow":"0px 0px 2px #444"},50)}),$(".delete-image").click(function(){var a=$(this).data("image");$("#"+a).fadeOut().remove();for(var b=_self.select_group.imagesSelected,c=0;c<b.length;c++)$(b[c]).attr("id")==a&&(b.splice(c,1),c--);$("#"+_self.minimap.namespace+a).remove(),_self.toolbar.refresh(),_self.select_group.imagesSelected.length?_self.toolbar.enable():_self.toolbar.disable();var d=$(".crop_button");1==_self.select_group.imagesSelected.length?d.removeClass("disabled"):d.addClass("disabled"),_self.comments.check_notes()})})):(a.name=void 0!==c&&c.length>28?c.substr(0,28)+"...":c,e.html(a.name),e.attr("title",c)),a.opacity=100*b.find("img").css("opacity"),a.rotate=d(b.css("transform")),a.width=b.find("img").css("width"),b.find("img").hasClass("flippedX")&&_self.toolbar.selectors.buttons.flipx.addClass("active"),b.find("img").hasClass("flippedY")&&_self.toolbar.selectors.buttons.flipy.addClass("active"),b.find("img").hasClass("invert")&&_self.toolbar.selectors.buttons.invert.addClass("active");var f;void 0!==document.body.style.webkitFilter?"none"!=b.css("-webkit-filter")?(f=2*b.css("-webkit-filter").getNums()*100,a.brightness=f):a.brightness=200:"undefined"!=typeof document.getElementById(b.attr("id")).style.polyfilterStore?(f=document.getElementById(b.attr("id")).style.polyfilterStore.getNums(),a.brightness=2*f):a.brightness=200}else c="",a.opacity=100,a.brightness=200;return a},d=c();_self.toolbar.selectors.sliders.opacity.slider("option","value",d.opacity),_self.toolbar.selectors.sliders.brightness.slider("option","value",d.brightness),_self.toolbar.selectors.sliders.rotate.slider("option","value",d.rotate)}),1==_self.select_group.imagesSelected.length?(_self.toolbar.selectors.buttons.cropButton.removeClass("disabled").attr("disabled",!1),_self.toolbar.selectors.buttons.createComment.removeClass("disabled").attr("disabled",!1),_self.toolbar.selectors.buttons.group.addClass("disabled").attr("disabled",!0),_self.comments.check_notes()):(_self.toolbar.selectors.buttons.cropButton.addClass("disabled").attr("disabled",!0),_self.toolbar.selectors.buttons.createComment.addClass("disabled").attr("disabled",!0),$("#open_notes").fadeOut().remove()),2==_self.select_group.imagesSelected.length?_self.toolbar.selectors.buttons.compare.removeClass("disabled").attr("disabled",!1):_self.toolbar.selectors.buttons.compare.addClass("disabled").attr("disabled",!0),_self.select_group.imagesSelected.length>=2||_self.select_group.imagesSelected.length&&$(".stickable_note.selected").length||$(".stickable_note.selected").length>=2?_self.toolbar.selectors.buttons.group.removeClass("disabled").attr("disabled",!1):_self.toolbar.selectors.buttons.group.addClass("disabled").attr("disabled",!0),_self.toolbar.refreshSize(),_self.select_group.imagesSelected.length?_self.toolbar.enable():_self.toolbar.disable()}},this.utils={fixZoom:function(a,b){var c=$("#workspace1").css("zoom"),d=$("#workspace1").height(),e=$("#workspace1").width();b.position.top=Math.round(b.position.top/c),b.position.left=Math.round(b.position.left/c),b.position.left<0&&(b.position.left=0),b.position.left+$(this).width()>e&&(b.position.left=e-$(this).width()),b.position.top<0&&(b.position.top=0),b.position.top+$(this).height()>d&&(b.position.top=d-$(this).height())},stringToXML:function(a){try{var b=null;if(window.DOMParser){var c=new DOMParser;b=c.parseFromString(a,"text/xml");var d=b.getElementsByTagName("parsererror");return d&&d.length&&d[0].childNodes.length?null:b}return b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a),b}catch(e){}},getParameter:function(a){var b,c,d=window.location.search.substring(1),e=d.split("&"),f=[];for(b=0;b<e.length;b++)c=e[b].split("="),c[0]==a&&f.push(unescape(c[1]));return f},getAspectRatio:function(a,b){var c=a/b;return Math.abs(c-4/3)<Math.abs(c-16/9)?"4:3":"16:9"},getCookie:function(a){var b=null;if(document.cookie&&""!==document.cookie)for(var c=document.cookie.split(";"),d=0;d<c.length;d++){var e=jQuery.trim(c[d]);if(e.substring(0,a.length+1)==a+"="){b=decodeURIComponent(e.substring(a.length+1));break}}return b}},this.workspaceImages={_self:this,beingDragged:!1,workspace:this.defaults.selectors.workspace1,draggableOptions:{revert:"valid",opacity:.7,stack:".image_active",cursor:"move",scroll:!0,drag:function(a,b){position=$(this).offset(),_self.minimap.update_mini_map(b)},stop:function(a){$(a.toElement).one("click",function(a){a.stopImmediatePropagation()})}},init:function(){this.make_images_draggable()},make_images_draggable:function(){var a=this.draggableOptions;$(".image_active").draggable(a).children("img").addClass("img-responsive")}}}$(document).ready(function(){void 0===document.body.style.webkitFilter&&(polyfilter_scriptpath="/static/js/libs/lib/",polyfilter_skip_stylesheets=!0,$.getScript("/static/js/libs/polyfill/cssParser.js"),$.getScript("/static/js/libs/polyfill/css-filters-polyfill.js"));var a={development:!0};$lightbox=new Lightbox(a),$lightbox.init()}),$(document).ready(function(){!function(){var a={input:"#search"},b={first_requestRunning:!1,init:function(){function b(){var a={pattern:c.val(),n:e};return $.ajax({type:"POST",url:"search/",data:a,beforeSend:function(){f.fadeIn()},success:function(a){if("False"!=a){var b="",c=a.count,d=a.manuscripts;for(i=0;i<d.length;i++){var e=d[i][2]+", "+d[i][4];b+='<div data-toggle="tooltip" title="'+e+'"  data-size = "'+d[i][5]+'" data-title = "'+d[i][2]+'" class="col-lg-4 col-md-4 col-xs-4 image" id = "'+d[i][1]+'">'+d[i][0]+"</div>"}g.html(b),$("#results_counter").hide().fadeIn().html("<span class='label label-default'>Results: "+c+"</span>"),$(".image[data-toggle='tooltip']").tooltip({placement:"bottom"})}else $.fn.notify({"close-button":!0,type:"error",text:"You should insert at least one search term",position:{top:"8%",left:"79%"}}),f.fadeOut()},complete:function(){function b(){$(this).data("requestRunning")||(a.x=a.n,a.n+=6,$.ajax({type:"POST",url:"search/",data:a,beforeSend:function(){f.fadeIn()},success:function(a){var b="";if("False"!=a){a=a.manuscripts;for(var c=0;c<a.length;c++){var d=a[c][2]+", "+a[c][4];b+='<div data-toggle="tooltip" title="'+d+'" data-size = "'+a[c][5]+'" data-title = "'+a[c][2]+'" class="col-lg-4 col-md-4 col-xs-4 image" id = "'+a[c][1]+'">'+a[c][0]+"</div>"}g.append(b)}else $.fn.notify({"close-button":!0,type:"error",text:"You should insert at least one search term",position:{top:"8%",left:"79%"}}),f.fadeOut()},complete:function(){$(this).data("requestRunning",!1);var a=$(".image");a.unbind("click"),a.click(function(){$lightbox.imagesBox.select_image($(this))}),a.find("img").on("load",function(){$(".image[data-toggle='tooltip']").tooltip({placement:"bottom"}),f.fadeOut(),a.find("img").fadeIn()})}}))}function c(a){return a.scrollTop+a.clientHeight==a.scrollHeight||a.scrollTop+a.clientHeight>a.scrollHeight?!0:void 0}this.first_requestRunning=!1;var d=$(".image");d.click(function(){$lightbox.imagesBox.select_image($(this))}),$("#load_more").attr("disabled",!1).click(b),g.data("requestRunning",!1);var e=document.getElementById("images_container");g.scroll(function(){c(e)&&(b(),f.fadeOut())}),$(this).data("requestRunning",!0),$(".image").find("img").on("load",function(){f.fadeOut(),$(this).fadeIn()})},error:function(){$.fn.notify({"close-button":!0,text:"Something went wrong. Try again.",position:{top:"8%",left:"79%"}}),f.fadeOut()}}),this.first_requestRunning=!0,!1}if(!this.first_requestRunning){var c=$(a.input),d=$("#search_button"),e=6,f=$("#ajax-loader"),g=$("#images_container");d.click(b),$(document).on("keydown",function(a){var c=a.keyCode?a.keyCode:a.which;13==c&&$("#search").is(":focus")&&b()})}}};b.init(a)}()});